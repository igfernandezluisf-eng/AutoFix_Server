<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AutoFix PRO v6.7.0</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0a0a0f">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        :root { --main-color: #00f3ff; --neon-red: #ff0055; --neon-green: #00ff9d; --neon-amber: #ffaa00; --bg-dark: #0a0a0f; --panel-bg: #141419; --text-main: #e0e0e0; }
        body { font-family: 'Segoe UI', monospace; background: var(--bg-dark); color: var(--text-main); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden; user-select: none; }
        header { width: 100%; max-width: 600px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .brand { font-size: 1.5rem; font-weight: 800; letter-spacing: 2px; }
        .brand span { color: var(--main-color); }
        .status-badge { background: #1a1a1a; padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; display: flex; align-items: center; gap: 8px; border: 1px solid #333; }
        .dot { width: 10px; height: 10px; border-radius: 50%; background: #555; }
        .dot.active { background: var(--neon-green); box-shadow: 0 0 10px var(--neon-green); }
        .dot.blue { background: #0072ff; box-shadow: 0 0 10px #0072ff; animation: pulse-blue 1s infinite; }
        .dot.rec { background: var(--neon-red); box-shadow: 0 0 10px var(--neon-red); animation: pulse-red 1s infinite; }
        @keyframes pulse-blue { 50% { opacity: 0.5; } }
        @keyframes pulse-red { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; max-width: 600px; margin-bottom: 15px; }
        .card { background: var(--panel-bg); border-radius: 15px; padding: 15px; display: flex; flex-direction: column; align-items: center; border: 1px solid #222; }
        .gauge-container { position: relative; width: 100px; height: 100px; }
        circle { fill: none; stroke-width: 8; stroke-linecap: round; transform: rotate(135deg); transform-origin: center; }
        .bg-circle { stroke: #2a2a30; }
        .progress-circle { stroke: var(--main-color); stroke-dasharray: 251; stroke-dashoffset: 251; transition: stroke-dashoffset 0.2s; }
        .gauge-value { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.2rem; font-weight: bold; color: #fff; }
        .toolbar { width: 100%; max-width: 600px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 20px; }
        .action-btn { background: #1a1a1a; color: #aaa; border: 1px solid #333; border-radius: 8px; padding: 12px 2px; display: flex; flex-direction: column; align-items: center; font-size: 0.6rem; font-weight: bold; cursor: pointer; transition: 0.2s; min-height: 65px; justify-content: center; }
        .action-btn span { font-size: 1.4rem; margin-bottom: 5px; }
        .btn-green { color: var(--neon-green); border-color: rgba(0,255,157,0.3); }
        .btn-red { color: var(--neon-red); border-color: rgba(255,0,85,0.3); }
        .btn-amber { color: var(--neon-amber); border-color: rgba(255,170,0,0.3); }
        .rec-active { background: #3a0000 !important; border-color: var(--neon-red) !important; color: var(--neon-red) !important; }
        .scan-btn { background: linear-gradient(135deg, var(--main-color), #0072ff); color: white; border: none; width: 100%; max-width: 600px; padding: 18px; font-size: 1.1rem; font-weight: bold; border-radius: 12px; margin-bottom: 15px; }
        .console { width: 100%; max-width: 600px; background: #000; border: 1px solid #333; border-radius: 8px; padding: 10px; height: 100px; overflow-y: auto; font-family: monospace; font-size: 0.75rem; color: #ccc; }
        .modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); overflow-y: auto; }
        .modal-content { background: #141419; margin: 5% auto; padding: 20px; border: 1px solid #444; width: 90%; max-width: 500px; border-radius: 12px; position: relative; }
        .close-modal { position: absolute; right: 15px; top: 10px; font-size: 24px; cursor: pointer; color: #fff; }
        .input-dark, select.input-dark { width: 100%; background: #222; border: 1px solid #444; color: #fff; padding: 12px; margin: 10px 0; border-radius: 5px; box-sizing: border-box; font-size: 1rem; }
        label { display: block; text-align: left; color: #888; font-size: 0.8rem; margin-top: 10px; }
        .btn-full { width: 100%; padding: 15px; background: var(--main-color); border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; color: #000; margin-top: 15px; }
        .btn-small { padding: 10px; background: #333; border: 1px solid #555; color: white; border-radius: 5px; width: 48%; margin: 1%; cursor: pointer; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; text-align: left; }
        .data-table th { color: var(--main-color); border-bottom: 1px solid #444; padding: 8px; }
        .data-table td { border-bottom: 1px solid #333; padding: 8px; color: #ccc; }
        .odo-display { font-family: 'Courier New', monospace; font-size: 2rem; color: var(--neon-amber); background: #000; border: 2px solid #333; padding: 15px; border-radius: 10px; text-align: center; }
        .service-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .service-btn { background: #161b22; border: 1px solid #30363d; border-radius: 10px; padding: 10px; text-align: center; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 90px; }
        .service-btn:active { background: #30363d; transform: scale(0.95); }
        .service-icon { font-size: 1.8rem; margin-bottom: 5px; color: var(--main-color); }
        .wizard-step { display: none; text-align: center; }
        .wizard-active { display: block; }
        .progress-bar-bg { width: 100%; background: #333; height: 8px; border-radius: 4px; margin-top: 20px; overflow: hidden; }
        .progress-bar-fill { height: 100%; background: var(--neon-green); width: 0%; transition: width 0.5s; }
        .player-controls { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        .player-btn { background: #333; border: none; color: white; padding: 10px 15px; border-radius: 5px; cursor: pointer; }
        .timeline { width: 100%; height: 5px; background: #333; margin-top: 20px; position: relative; }
        .timeline-progress { height: 100%; background: var(--neon-amber); width: 0%; }
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0a0a0f; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <h1 style="color:#fff; font-family:'Segoe UI';">AutoFix <span style="color:var(--main-color)">PRO v6.7.0</span></h1>
        <div style="width: 100%; max-width: 320px; text-align: center; background: #141419; padding: 30px; border-radius: 15px; border: 1px solid #333;">
            <h2 style="color:#ccc;">Acceso Taller</h2>
            <input type="email" id="login-email" class="input-dark" placeholder="correo@taller.com" style="text-align:center;">
            <button id="btnLogin" class="btn-full" onclick="attemptLogin()">INICIAR SISTEMA</button>
            <div id="login-msg" style="margin-top:20px; color:#ff0055; font-size:0.8rem;">v6.7.0 (DYNAMIC SIM)</div>
        </div>
    </div>

    <header>
        <div class="brand">AutoFix <span>PRO v6.7.0</span></div>
        <div class="status-badge"><div id="conn-dot" class="dot"></div><span id="conn-text">OFFLINE</span></div>
    </header>

    <div class="dashboard">
        <div class="card"><span>RPM MOTOR</span><div class="gauge-container"><svg width="100" height="100"><circle class="bg-circle" cx="50" cy="50" r="40"></circle><circle id="rpm-circle" class="progress-circle" cx="50" cy="50" r="40"></circle></svg><div class="gauge-value" id="rpm-val">--</div></div></div>
        <div class="card"><span>TEMPERATURA</span><div class="gauge-container"><svg width="100" height="100"><circle class="bg-circle" cx="50" cy="50" r="40"></circle><circle id="temp-circle" class="progress-circle" cx="50" cy="50" r="40" style="stroke:var(--neon-red)"></circle></svg><div class="gauge-value" id="temp-val">--</div></div></div>
    </div>

    <div class="toolbar">
        <button class="action-btn" onclick="toggleSunMode()"><span class="material-icons-round">wb_sunny</span>SOL</button>
        <button class="action-btn" onclick="toggleVoice()"><span class="material-icons-round">mic</span>VOZ</button>
        <button class="action-btn btn-green" onclick="openModal('quoteModal')"><span class="material-icons-round">attach_money</span>COTIZAR</button>
        <button class="action-btn btn-amber" onclick="openModal('inventoryModal')"><span class="material-icons-round">inventory_2</span>INV</button>
        <button class="action-btn" onclick="openModal('crmModal')"><span class="material-icons-round">groups</span>CRM</button>
        <button class="action-btn btn-green" onclick="openModal('predictModal')"><span class="material-icons-round">auto_graph</span>PRED</button>
        <button id="btnRec" class="action-btn btn-red" onclick="toggleRec()"><span class="material-icons-round">fiber_manual_record</span>REC</button>
        <button class="action-btn" onclick="openModal('topologyModal')"><span class="material-icons-round">hub</span>NET</button>
        <button class="action-btn" onclick="openFreezeFrame()"><span class="material-icons-round">ac_unit</span>FREEZE</button>
        <button class="action-btn btn-green" onclick="openModal('serviceModal')"><span class="material-icons-round">build</span>SERV</button>
        <button class="action-btn btn-green" onclick="openScope()"><span class="material-icons-round">ssid_chart</span>SCOPE</button>
        <button class="action-btn" onclick="openModal('sensorModal')"><span class="material-icons-round">tune</span>SENSORES</button>
        <button class="action-btn btn-amber" onclick="openOdometerTool()"><span class="material-icons-round">speed</span>KM</button>
        <button class="action-btn" onclick="openModal('garageModal')"><span class="material-icons-round">directions_car</span>GARAJE</button>
        <button class="action-btn btn-green" onclick="openModal('testsModal')"><span class="material-icons-round">bolt</span>TEST</button>
        <button class="action-btn btn-amber" onclick="testSecurity()"><span class="material-icons-round">lock_open</span>SEGURIDAD</button>
        <button class="action-btn btn-red" onclick="openHexEditor()"><span class="material-icons-round">memory</span>HEX</button>
        <button class="action-btn" onclick="openHistory()"><span class="material-icons-round">history</span>HIST</button>
        <button class="action-btn" onclick="openModal('settingsModal')"><span class="material-icons-round">settings</span>CONF</button>
        <button class="action-btn btn-blue" onclick="connectOrSync()"><span class="material-icons-round">bluetooth</span>SYNC</button>
    </div>

    <button class="scan-btn" onclick="startScan()">üîç ESCANEAR SISTEMA</button>
    <div class="console" id="console"><div>> AutoFix v6.7.0 Ready.</div></div>

    <div id="freezeModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('freezeModal')">&times;</span>
            <h2 style="color:var(--neon-amber); border-bottom:1px solid #333; padding-bottom:10px;">CUADRO CONGELADO</h2>
            <div style="background:#1a1a1a; padding:10px; border-radius:5px; margin-bottom:15px; text-align:left;">
                <p style="margin:5px 0;"><strong>C√≥digo Causante:</strong> <span id="ff-code" style="color:var(--neon-red); font-size:1.1rem;">---</span> <span id="ff-desc">---</span></p>
                <p style="margin:5px 0;"><strong>Estado:</strong> <span style="color:#ffcc00;">ALMACENADO</span></p>
            </div>
            <h3 style="text-align:left; font-size:1rem; color:#888;">SNAPSHOT DE SENSORES</h3>
            <table class="data-table">
                <tr><th>PAR√ÅMETRO</th><th>VALOR REGISTRADO</th></tr>
                <tr><td>RPM del Motor</td><td id="ff-rpm" style="color:var(--main-color)">---</td></tr>
                <tr><td>Velocidad (VSS)</td><td id="ff-vss" style="color:var(--main-color)">---</td></tr>
                <tr><td>Temperatura (ECT)</td><td id="ff-ect" style="color:var(--main-color)">---</td></tr>
                <tr><td>Carga del Motor (LOAD)</td><td id="ff-load" style="color:var(--main-color)">---</td></tr>
                <tr><td>Fuel Trim (Corto)</td><td id="ff-trim" style="color:var(--neon-red)">---</td></tr>
                <tr><td>Posici√≥n Acelerador</td><td id="ff-tps" style="color:var(--main-color)">---</td></tr>
                <tr><td>Presi√≥n M√∫ltiple (MAP)</td><td id="ff-map" style="color:var(--main-color)">---</td></tr>
            </table>
            <div style="margin-top:15px; display:flex; justify-content:space-between;">
                <button class="btn-small" style="width:30%" onclick="openFreezeFrame()">&lt; Anterior</button>
                <button class="btn-small" style="width:30%">Imprimir</button>
                <button class="btn-small" style="width:30%" onclick="openFreezeFrame()">Siguiente &gt;</button>
            </div>
        </div>
    </div>

    <div id="historyModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('historyModal')">&times;</span>
            <h2>HISTORIAL DE GRABACIONES</h2>
            <div id="logList" style="margin-bottom: 20px; text-align: left;"><p style="color:#888;">No hay grabaciones recientes.</p></div>
            <div id="logPlayer" style="display:none; background:#222; padding:15px; border-radius:10px;">
                <h3 id="playTitle" style="color:var(--neon-green)">Reproduciendo...</h3>
                <div class="timeline"><div id="playProgress" class="timeline-progress"></div></div>
                <div class="player-controls">
                    <button class="player-btn" onclick="playLog()">‚ñ∂ PLAY</button>
                    <button class="player-btn" onclick="pauseLog()">‚è∏ PAUSE</button>
                    <button class="player-btn" onclick="stopLog()">‚èπ STOP</button>
                </div>
            </div>
        </div>
    </div>

    <div id="serviceModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('serviceModal')">&times;</span>
            <h2 style="color:var(--neon-green)">FUNCIONES DE SERVICIO</h2>
            <div class="service-grid">
                <div class="service-btn" onclick="startWizard('OIL')"><span class="service-icon">üõ¢Ô∏è</span><small>OIL RESET</small></div>
                <div class="service-btn" onclick="startWizard('EPB')"><span class="service-icon">üÖøÔ∏è</span><small>EPB</small></div>
                <div class="service-btn" onclick="startWizard('SAS')"><span class="service-icon">‚ò∏Ô∏è</span><small>SAS</small></div>
                <div class="service-btn" onclick="startWizard('DPF')"><span class="service-icon">üí®</span><small>DPF</small></div>
                <div class="service-btn" onclick="startWizard('BMS')"><span class="service-icon">üîã</span><small>BMS</small></div>
                <div class="service-btn" onclick="startWizard('ABS')"><span class="service-icon">üõë</span><small>ABS</small></div>
                <div class="service-btn" onclick="startWizard('INJ')"><span class="service-icon">üíâ</span><small>INJ</small></div>
                <div class="service-btn" onclick="startWizard('TPS')"><span class="service-icon">ü¶ã</span><small>TPS</small></div>
                <div class="service-btn" onclick="startWizard('TPMS')"><span class="service-icon">üõû</span><small>TPMS</small></div>
                <div class="service-btn" onclick="startWizard('GEAR')"><span class="service-icon">‚öôÔ∏è</span><small>CAJA</small></div>
                <div class="service-btn" onclick="startWizard('IMMO')"><span class="service-icon">üîë</span><small>IMMO</small></div>
                <div class="service-btn" onclick="startWizard('SUS')"><span class="service-icon">üéà</span><small>SUS</small></div>
                <div class="service-btn" onclick="startWizard('SUN')"><span class="service-icon">‚òÄÔ∏è</span><small>TECHO</small></div>
                <div class="service-btn" onclick="startWizard('AFS')"><span class="service-icon">üí°</span><small>LUCES</small></div>
                <div class="service-btn" onclick="startWizard('EGR')"><span class="service-icon">‚ôªÔ∏è</span><small>EGR</small></div>
            </div>
        </div>
    </div>

    <div id="wizardModal" class="modal" style="z-index: 210;">
        <div class="modal-content" style="text-align: center;">
            <span class="close-modal" onclick="closeModal('wizardModal')">&times;</span>
            <h2 id="wizTitle" style="color:var(--main-color)">ASISTENTE</h2>
            <div id="wizStep1" class="wizard-step">
                <p id="wizInstr" style="color:#ccc; font-size:1.1rem; margin: 20px 0;">Instrucciones...</p>
                <div style="background:rgba(255,0,0,0.2); border:1px solid red; padding:10px; margin-bottom:20px;"><strong style="color:red">‚ö† ADVERTENCIA:</strong><br>No apague el motor.</div>
                <button class="btn-full" onclick="nextStep(2)">CONTINUAR</button>
            </div>
            <div id="wizStep2" class="wizard-step">
                <p>Seleccione una funci√≥n:</p>
                <button class="btn-full" style="background:#333; margin-bottom:10px;" onclick="executeAction('RESET/ABRIR')">EJECUTAR</button>
                <button class="btn-full" style="background:#333;" onclick="executeAction('CERRAR/CALIBRAR')">CANCELAR</button>
            </div>
            <div id="wizStep3" class="wizard-step">
                <p>Comunicando con ECU...</p>
                <div class="progress-bar-bg"><div id="wizBar" class="progress-bar-fill"></div></div>
            </div>
            <div id="wizStep4" class="wizard-step">
                <div style="font-size:4rem; margin:20px 0;">‚úÖ</div>
                <h3 style="color:var(--neon-green)">¬°EXITOSO!</h3>
                <button class="btn-full" onclick="closeModal('wizardModal')">FINALIZAR</button>
            </div>
        </div>
    </div>

    <div id="scopeModal" class="modal"><div class="modal-content">
        <span class="close-modal" onclick="closeScope()">&times;</span>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h2>OSCILOSCOPIO</h2>
            <select id="scopeSensor" class="input-dark" style="width:160px; margin:0; padding:5px; font-size:0.9rem;" onchange="resetScope()">
                <option value="O2">O2 - Ox√≠geno</option>
                <option value="CKP">CKP - Cig√ºe√±al</option>
                <option value="CMP">CMP - Levas</option>
                <option value="MAF">MAF - Flujo Aire</option>
                <option value="TPS">TPS - Acelerador</option>
                <option value="MAP">MAP - Presi√≥n</option>
                <option value="KS">KS - Detonaci√≥n</option>
                <option value="ABS">ABS - Rueda</option>
                <option value="INJ">INJ - Inyectores</option>
                <option value="IG">IG - Bobina 1¬∫</option>
            </select>
        </div>
        <canvas id="scopeCanvas" width="300" height="150" style="background:#000; border:1px solid #333; width:100%;"></canvas>
        <p style="font-size:0.8rem; color:#00ff9d;" id="scopeLabel">Analizando Se√±al...</p>
    </div></div>

    <div id="sensorModal" class="modal"><div class="modal-content">
        <span class="close-modal" onclick="closeModal('sensorModal')">&times;</span>
        <h2>DATOS EN VIVO</h2>
        <table class="data-table">
            <tr><th>SENSOR</th><th>VALOR</th></tr>
            <tr><td>RPM Motor</td><td id="s-rpm" style="color:var(--main-color)">---</td></tr>
            <tr><td>Temp. Refrig.</td><td id="s-temp">---</td></tr>
            <tr><td>Voltaje Bater√≠a</td><td id="s-batt">12.4 V</td></tr>
            <tr><td>MAP Manifold</td><td id="s-map">34 kPa</td></tr>
            <tr><td>IAT Intake Temp</td><td id="s-iat">45 ¬∞C</td></tr>
            <tr><td>TPS Throttle</td><td id="s-tps">12 %</td></tr>
        </table>
    </div></div>

    <div id="testsModal" class="modal"><div class="modal-content">
        <span class="close-modal" onclick="closeModal('testsModal')">&times;</span>
        <h2>PRUEBA DE ACTUADORES</h2>
        <div style="display:flex; flex-wrap:wrap;">
            <button class="btn-small" onclick="alert('Comando enviado: FAN ON')">FAN 1 ON</button>
            <button class="btn-small" onclick="alert('Comando enviado: FAN OFF')">FAN 1 OFF</button>
            <button class="btn-small" onclick="alert('Comando enviado: INJ CUT')">CORTE INY</button>
            <button class="btn-small" onclick="alert('Comando enviado: PUMP ON')">BOMBA GAS</button>
        </div>
    </div></div>

    <div id="odoModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="closeModal('odoModal')">&times;</span><h2>OD√ìMETRO</h2><div class="odo-display" id="odo-current">---</div><input type="number" id="odo-new" class="input-dark" placeholder="Nuevo Km"><button class="btn-full" onclick="writeOdometer()">PROGRAMAR</button></div></div>
    <div id="settingsModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="closeModal('settingsModal')">&times;</span><h2>CONFIGURACI√ìN</h2>
        <label>Interface Hardware</label><select id="conf-hw" class="input-dark"><option value="sim">üîå Modo Simulaci√≥n</option><option value="elm">üì∂ ELM327 BLE (Real)</option><option value="j2534">üì° J2534 Passthru</option><option value="usb">üíª Cable USB</option></select>
        <label>Motor de IA</label><select id="conf-ai" class="input-dark"><option value="gemini">‚ú® Google Gemini Ultra</option><option value="gpt">üß† GPT-4 Turbo</option></select>
        <label>Taller</label><input type="text" class="input-dark" value="Taller Principal"><button class="btn-full" onclick="saveSettings()">GUARDAR</button></div></div>
    <div id="inventoryModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="closeModal('inventoryModal')">&times;</span><h2>INVENTARIO</h2><table class="data-table"><tr><th>Item</th><th>Stock</th></tr><tr><td>Filtro 5W30</td><td>12</td></tr><tr><td>Buj√≠a NGK</td><td>24</td></tr></table></div></div>
    <div id="crmModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="closeModal('crmModal')">&times;</span><h2>CRM</h2><p>Juan P. - Fiesta 2015 (Listo)</p></div></div>
    <div id="quoteModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="closeModal('quoteModal')">&times;</span><h2>COTIZAR</h2><p>Total: $ 85.00</p><button class="btn-full">GENERAR</button></div></div>
    <div id="predictModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="closeModal('predictModal')">&times;</span><h2>IA</h2><p>Salud: 85%</p></div></div>
    <div id="topologyModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="closeModal('topologyModal')">&times;</span><h2>CAN BUS</h2><p>ECU ‚óè OK</p></div></div>
    <div id="garageModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="closeModal('garageModal')">&times;</span><h2>GARAJE</h2><p>Nissan Sentra 2018</p></div></div>
    <div id="hexModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="closeModal('hexModal')">&times;</span><h2>HEX</h2><textarea class="input-dark">00 FF A1 B2...</textarea></div></div>

    <script>
        const API_URL = "https://autofix-server-7w12.onrender.com";
        let currentUserPlan = 'FREE';
        let simulatedKm = 125430;
        let hardwareMode = 'sim';
        let bleDevice = null;
        let scopeTimer = null;
        let isRecording = false;
        let logSession = [];
        let logTimer = null;
        let savedLogs = [];
        let playInterval = null;

        const servicesData = {
            'OIL': { title: 'RESET ACEITE', instr: 'Encienda el contacto (ON). Motor apagado.' },
            'EPB': { title: 'FRENOS EPB', instr: 'Suelte el freno de mano. Bater√≠a > 12V.' },
            'SAS': { title: 'CALIBRAR VOLANTE', instr: 'Coloque volante recto (0 grados).' },
            'DPF': { title: 'REGENERAR DPF', instr: 'Motor encendido. Temperatura > 70¬∞C.' },
            'BMS': { title: 'BATER√çA BMS', instr: 'Bater√≠a nueva instalada. Contacto ON.' },
            'ABS': { title: 'PURGA ABS', instr: 'Pise el freno. Se activar√° la bomba.' },
            'INJ': { title: 'INYECTORES', instr: 'Ingrese c√≥digos de inyectores nuevos.' },
            'TPS': { title: 'CUERPO ACELERACI√ìN', instr: 'Limpie la mariposa antes de iniciar.' },
            'TPMS': { title: 'RESET TPMS', instr: 'Ajuste presi√≥n de neum√°ticos primero.' },
            'GEAR': { title: 'APRENDIZAJE CAJA', instr: 'Procedimiento de marcha en carretera.' },
            'IMMO': { title: 'LLAVES IMMO', instr: 'Tenga todas las llaves presentes.' },
            'SUS': { title: 'SUSPENSI√ìN', instr: 'Veh√≠culo en superficie plana.' },
            'SUN': { title: 'TECHO SOLAR', instr: 'Cierre el techo completamente.' },
            'AFS': { title: 'FAROS AFS', instr: 'Nivelar veh√≠culo frente a pared.' },
            'EGR': { title: 'ADAPTACI√ìN EGR', instr: 'V√°lvula limpia o reemplazada.' }
        };

        // --- DATABASE DE FALLOS (FREEZE FRAME DIN√ÅMICO v6.7.0) ---
        const freezeFrames = [
            { code: 'P0300', desc: '(Misfire Random)', rpm: '2540', vss: '85', ect: '98', load: '45', trim: '+12 %', tps: '32', map: '45' },
            { code: 'P0171', desc: '(Mezcla Pobre B1)', rpm: '850', vss: '0', ect: '95', load: '18', trim: '+25 %', tps: '12', map: '32' },
            { code: 'P0420', desc: '(Catalizador B1)', rpm: '1800', vss: '60', ect: '92', load: '30', trim: '+3 %', tps: '25', map: '40' },
            { code: 'P0113', desc: '(IAT Alto Voltaje)', rpm: '0', vss: '0', ect: '40', load: '0', trim: '0 %', tps: '0', map: '101' },
            { code: 'P0217', desc: '(Sobrecalentamiento)', rpm: '3200', vss: '110', ect: '118', load: '75', trim: '-5 %', tps: '60', map: '80' }
        ];

        async function attemptLogin() {
            const email = document.getElementById('login-email').value.trim();
            const btn = document.getElementById('btnLogin');
            if(!email) { alert("Escribe correo"); return; }
            btn.innerText = "CONECTANDO..."; btn.disabled = true;
            try {
                const r = await fetch(`${API_URL}/api/login`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ email: email })
                });
                const d = await r.json();
                if (d.status === 'success') {
                    currentUserPlan = d.plan;
                    document.getElementById('loginOverlay').style.display = 'none';
                    setInterval(mainLoop, 1000);
                } else { alert(d.message); btn.disabled = false; }
            } catch (e) { alert("Error Red Render"); btn.disabled = false; }
        }

        function mainLoop() { 
            if (hardwareMode === 'sim' && !playInterval) updateFromRender(); 
        }

        async function updateFromRender() {
            try {
                const r = await fetch(`${API_URL}/live`);
                const d = await r.json();
                updateAllData(d.rpm, d.coolant_temp, "SIM: " + d.vin, true);
            } catch(e) {}
        }

        function updateAllData(rpm, temp, label, active) {
            document.getElementById('rpm-val').innerText = rpm;
            document.getElementById('temp-val').innerText = temp + "¬∞C";
            document.getElementById('rpm-circle').style.strokeDashoffset = 251 - (rpm/8000*251);
            document.getElementById('temp-circle').style.strokeDashoffset = 251 - (temp/130*251);
            document.getElementById('conn-dot').className = active ? 'dot active' : 'dot';
            document.getElementById('conn-text').innerText = label;

            if(document.getElementById('sensorModal').style.display === 'block') {
                document.getElementById('s-rpm').innerText = rpm;
                document.getElementById('s-temp').innerText = temp + " ¬∞C";
                document.getElementById('s-batt').innerText = (12.4 + Math.random()*0.5).toFixed(1) + " V";
                document.getElementById('s-map').innerText = (30 + Math.random()*5).toFixed(0) + " kPa";
            }

            if(isRecording) {
                logSession.push({rpm: rpm, temp: temp});
                const seconds = logSession.length;
                const min = Math.floor(seconds / 60);
                const sec = seconds % 60;
                document.getElementById('conn-text').innerText = "REC " + (min<10?'0':'')+min + ":" + (sec<10?'0':'')+sec;
            }
        }

        function setStatusOffline() { 
            updateAllData("--", "--", "OFFLINE", false);
        }

        // --- FUNCI√ìN DIN√ÅMICA DE FREEZE FRAME (v6.7.0) ---
        function openFreezeFrame() {
            openModal('freezeModal');
            // Elegir un error aleatorio de la base de datos
            const error = freezeFrames[Math.floor(Math.random() * freezeFrames.length)];
            
            document.getElementById('ff-code').innerText = error.code;
            document.getElementById('ff-desc').innerText = error.desc;
            document.getElementById('ff-rpm').innerText = error.rpm + " rpm";
            document.getElementById('ff-vss').innerText = error.vss + " km/h";
            document.getElementById('ff-ect').innerText = error.ect + " ¬∞C";
            document.getElementById('ff-load').innerText = error.load + " %";
            document.getElementById('ff-trim').innerText = error.trim;
            document.getElementById('ff-tps').innerText = error.tps + " %";
            document.getElementById('ff-map').innerText = error.map + " kPa";
        }

        function toggleRec() {
            const btn = document.getElementById('btnRec');
            if(!isRecording) {
                isRecording = true;
                logSession = [];
                btn.className = "action-btn rec-active";
                alert("GRABACI√ìN INICIADA\nConduzca el veh√≠culo para capturar datos.");
                document.getElementById('conn-dot').className = 'dot rec';
            } else {
                isRecording = false;
                btn.className = "action-btn btn-red";
                document.getElementById('conn-dot').className = 'dot active';
                if(logSession.length > 5) {
                    const name = "Log " + new Date().toLocaleTimeString();
                    savedLogs.push({name: name, data: [...logSession]});
                    alert("GRABACI√ìN GUARDADA:\n" + name + "\n(" + logSession.length + " segundos)");
                } else {
                    alert("Grabaci√≥n muy corta, no se guard√≥.");
                }
            }
        }

        function openHistory() {
            openModal('historyModal');
            const list = document.getElementById('logList');
            list.innerHTML = "";
            if(savedLogs.length === 0) {
                list.innerHTML = '<p style="color:#888;">No hay grabaciones recientes.</p>';
                return;
            }
            savedLogs.forEach((log, index) => {
                list.innerHTML += `<div style="background:#333; padding:10px; margin:5px 0; border-radius:5px; cursor:pointer;" onclick="loadLog(${index})">
                    <strong>${log.name}</strong><br><small>${log.data.length} segundos</small>
                </div>`;
            });
        }

        let currentPlayLog = null;
        function loadLog(index) {
            currentPlayLog = savedLogs[index].data;
            document.getElementById('logList').style.display = 'none';
            document.getElementById('logPlayer').style.display = 'block';
            document.getElementById('playTitle').innerText = savedLogs[index].name;
        }

        function playLog() {
            if(!currentPlayLog) return;
            let i = 0;
            const bar = document.getElementById('playProgress');
            if(playInterval) clearInterval(playInterval);
            playInterval = setInterval(() => {
                if(i >= currentPlayLog.length) {
                    clearInterval(playInterval);
                    return;
                }
                const data = currentPlayLog[i];
                updateAllData(data.rpm, data.temp, "PLAYBACK", true);
                bar.style.width = ((i / currentPlayLog.length) * 100) + "%";
                i++;
            }, 1000);
        }

        function pauseLog() { if(playInterval) clearInterval(playInterval); }

        function stopLog() {
            pauseLog();
            document.getElementById('logPlayer').style.display = 'none';
            document.getElementById('logList').style.display = 'block';
            setStatusOffline();
        }

        function startWizard(serviceType) {
            closeModal('serviceModal');
            openModal('wizardModal');
            const data = servicesData[serviceType];
            document.getElementById('wizTitle').innerText = data.title;
            document.getElementById('wizInstr').innerText = data.instr;
            nextStep(1);
        }

        function nextStep(step) {
            for(let i=1; i<=4; i++) document.getElementById('wizStep'+i).style.display = 'none';
            document.getElementById('wizStep'+step).style.display = 'block';
        }

        function executeAction(actionName) {
            nextStep(3);
            let width = 0;
            const bar = document.getElementById('wizBar');
            const interval = setInterval(() => {
                if (width >= 100) {
                    clearInterval(interval);
                    nextStep(4);
                } else {
                    width++;
                    bar.style.width = width + '%';
                }
            }, 30);
        }

        function openScope() {
            openModal('scopeModal');
            resetScope();
        }

        function closeScope() {
            closeModal('scopeModal');
            if(scopeTimer) clearInterval(scopeTimer);
        }

        function resetScope() {
            if(scopeTimer) clearInterval(scopeTimer);
            const sensor = document.getElementById('scopeSensor').value;
            const canvas = document.getElementById('scopeCanvas');
            const ctx = canvas.getContext('2d');
            const label = document.getElementById('scopeLabel');
            label.innerText = "Monitor: " + sensor + " (Live)";
            let x = 0; let y = 0;
            ctx.fillStyle = "#000"; ctx.fillRect(0,0,300,150);

            scopeTimer = setInterval(() => {
                x += 3; 
                if(x > 300) { x = 0; ctx.fillStyle = "rgba(0,0,0,0.15)"; ctx.fillRect(0,0,300,150); }
                const t = Date.now() / 1000;
                switch(sensor) {
                    case 'O2': y = 75 + Math.sin(t * 2) * 40 + (Math.random() * 5); break;
                    case 'CKP': y = 75 + Math.sin(t * 20) * 50; break;
                    case 'CMP': y = (Math.sin(t * 10) > 0) ? 40 : 110; break;
                    case 'MAF': y = 75 + Math.sin(t * 5) * 30 + (Math.random() * 10); break;
                    case 'TPS': y = 120 - (Math.sin(t * 0.5) * 40 + 40); break;
                    case 'MAP': y = 60 + (Math.random() * 10); break;
                    case 'KS': y = 75; if(Math.random() > 0.95) y -= 50 * Math.random(); break;
                    case 'ABS': y = 75 + Math.sin(t * 15) * 40; break;
                    case 'INJ': y = (Math.sin(t * 15) > 0.8) ? 100 : 20; break;
                    case 'IG': y = 75; if(Math.random() > 0.9) y = 10; break;
                    default: y = 75;
                }
                ctx.fillStyle = "#00ff9d"; ctx.fillRect(x, y, 3, 3);
            }, 20);
        }

        async function connectBluetooth() {
            if (!navigator.bluetooth) { alert("Use Google Chrome en Android para Bluetooth."); return; }
            try {
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb', '0000fff0-0000-1000-8000-00805f9b34fb', 'generic_access']
                });
                alert("Conectado: " + device.name);
                startDummyBLELoop(device.name);
            } catch (e) { alert("Error Conexi√≥n: " + e.message); }
        }

        function startDummyBLELoop(name) {
            let fakeRpm = 800;
            setInterval(() => {
                if(!isRecording && !playInterval) {
                    fakeRpm += Math.floor(Math.random() * 100) - 50;
                    updateAllData(fakeRpm, 88, "BLE: " + name, true);
                }
            }, 1000);
        }

        function connectOrSync() { if (hardwareMode === 'elm') connectBluetooth(); else window.location.reload(true); }
        function saveSettings() { hardwareMode = document.getElementById('conf-hw').value; alert("Configuraci√≥n Aplicada."); closeModal('settingsModal'); if(hardwareMode !== 'sim') setStatusOffline(); }
        function openOdometerTool() { if(currentUserPlan !== 'MASTER') { alert("Nivel MASTER requerido"); return; } openModal('odoModal'); document.getElementById('odo-current').innerText = simulatedKm.toLocaleString() + " Km"; }
        function writeOdometer() { simulatedKm = parseInt(document.getElementById('odo-new').value); document.getElementById('odo-current').innerText = simulatedKm.toLocaleString() + " Km"; alert("Escritura Completa."); }
        function openModal(id) { document.getElementById(id).style.display = 'block'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function toggleSunMode() { document.body.style.background = document.body.style.background==='white'?'#0a0a0f':'white'; }
        function toggleVoice() { alert("Escuchando comandos por voz..."); }
        function startScan() { alert("Escan√©o OBD2 Iniciado..."); setTimeout(()=>alert("Sin c√≥digos de falla (DTC) encontrados."), 2000); }
        function testSecurity() { alert("Bypassing Security Gateway... OK"); }
        function openHexEditor(){openModal('hexModal')}
    </script>
</body>
</html>
