<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AutoFix PRO v6.0.0 (APK)</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        :root { --main-color: #00f3ff; --neon-red: #ff0055; --neon-green: #00ff9d; --neon-amber: #ffaa00; --bg-dark: #0a0a0f; --panel-bg: #141419; --text-main: #e0e0e0; }
        body { font-family: 'Segoe UI', monospace; background: var(--bg-dark); color: var(--text-main); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden; }
        header { width: 100%; max-width: 600px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .brand { font-size: 1.5rem; font-weight: 800; letter-spacing: 2px; }
        .brand span { color: var(--main-color); }
        .status-badge { background: #1a1a1a; padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; display: flex; align-items: center; gap: 8px; border: 1px solid #333; }
        .dot { width: 10px; height: 10px; border-radius: 50%; background: #555; }
        .dot.active { background: var(--neon-green); box-shadow: 0 0 10px var(--neon-green); }
        .dot.blue { background: #0072ff; box-shadow: 0 0 10px #0072ff; animation: pulse-blue 1s infinite; }
        @keyframes pulse-blue { 50% { opacity: 0.5; } }
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; max-width: 600px; margin-bottom: 15px; }
        .card { background: var(--panel-bg); border-radius: 15px; padding: 15px; display: flex; flex-direction: column; align-items: center; border: 1px solid #222; }
        .gauge-container { position: relative; width: 100px; height: 100px; }
        circle { fill: none; stroke-width: 8; stroke-linecap: round; transform: rotate(135deg); transform-origin: center; }
        .bg-circle { stroke: #2a2a30; }
        .progress-circle { stroke: var(--main-color); stroke-dasharray: 251; stroke-dashoffset: 251; transition: stroke-dashoffset 0.2s; }
        .gauge-value { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.2rem; font-weight: bold; color: #fff; }
        .toolbar { width: 100%; max-width: 600px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 20px; }
        .action-btn { background: #1a1a1a; color: #aaa; border: 1px solid #333; border-radius: 8px; padding: 12px 2px; display: flex; flex-direction: column; align-items: center; font-size: 0.6rem; font-weight: bold; cursor: pointer; transition: 0.2s; min-height: 65px; justify-content: center; }
        .action-btn span { font-size: 1.4rem; margin-bottom: 5px; }
        .btn-green { color: var(--neon-green); border-color: rgba(0,255,157,0.3); }
        .btn-red { color: var(--neon-red); border-color: rgba(255,0,85,0.3); }
        .btn-amber { color: var(--neon-amber); border-color: rgba(255,170,0,0.3); }
        .scan-btn { background: linear-gradient(135deg, var(--main-color), #0072ff); color: white; border: none; width: 100%; max-width: 600px; padding: 18px; font-size: 1.1rem; font-weight: bold; border-radius: 12px; margin-bottom: 15px; }
        .console { width: 100%; max-width: 600px; background: #000; border: 1px solid #333; border-radius: 8px; padding: 10px; height: 100px; overflow-y: auto; font-family: monospace; font-size: 0.75rem; color: #ccc; }
        .modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); overflow-y: auto; }
        .modal-content { background: #141419; margin: 5% auto; padding: 20px; border: 1px solid #444; width: 90%; max-width: 500px; border-radius: 12px; position: relative; }
        .close-modal { position: absolute; right: 15px; top: 10px; font-size: 24px; cursor: pointer; color: #fff; }
        .input-dark, select.input-dark { width: 100%; background: #222; border: 1px solid #444; color: #fff; padding: 12px; margin: 10px 0; border-radius: 5px; box-sizing: border-box; font-size: 1rem; }
        label { display: block; text-align: left; color: #888; font-size: 0.8rem; margin-top: 10px; }
        .btn-full { width: 100%; padding: 15px; background: var(--main-color); border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; color: #000; margin-top: 15px; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.8rem; text-align: left; }
        .data-table th { color: var(--main-color); border-bottom: 1px solid #444; padding: 8px; }
        .data-table td { border-bottom: 1px solid #333; padding: 8px; color: #ccc; }
        .odo-display { font-family: 'Courier New', monospace; font-size: 2rem; color: var(--neon-amber); background: #000; border: 2px solid #333; padding: 15px; border-radius: 10px; text-align: center; }
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0a0a0f; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <h1 style="color:#fff; font-family:'Segoe UI';">AutoFix <span style="color:var(--main-color)">PRO</span></h1>
        <div style="width: 100%; max-width: 320px; text-align: center; background: #141419; padding: 30px; border-radius: 15px; border: 1px solid #333;">
            <h2 style="color:#ccc;">Acceso Taller</h2>
            <input type="email" id="login-email" class="input-dark" placeholder="correo@taller.com" style="text-align:center;">
            <button id="btnLogin" class="btn-full" onclick="attemptLogin()">INICIAR SISTEMA</button>
            <div id="login-msg" style="margin-top:20px; color:#ff0055; font-size:0.8rem;">v6.0.0 (APK)</div>
        </div>
    </div>

    <header>
        <div class="brand">AutoFix <span>PRO v6.0.0</span></div>
        <div class="status-badge"><div id="conn-dot" class="dot"></div><span id="conn-text">OFFLINE</span></div>
    </header>

    <div class="dashboard">
        <div class="card"><span>RPM MOTOR</span><div class="gauge-container"><svg width="100" height="100"><circle class="bg-circle" cx="50" cy="50" r="40"></circle><circle id="rpm-circle" class="progress-circle" cx="50" cy="50" r="40"></circle></svg><div class="gauge-value" id="rpm-val">--</div></div></div>
        <div class="card"><span>TEMPERATURA</span><div class="gauge-container"><svg width="100" height="100"><circle class="bg-circle" cx="50" cy="50" r="40"></circle><circle id="temp-circle" class="progress-circle" cx="50" cy="50" r="40" style="stroke:var(--neon-red)"></circle></svg><div class="gauge-value" id="temp-val">--</div></div></div>
    </div>

    <div class="toolbar">
        <button class="action-btn" onclick="toggleSunMode()"><span class="material-icons-round">wb_sunny</span>SOL</button>
        <button class="action-btn" onclick="toggleVoice()"><span class="material-icons-round">mic</span>VOZ</button>
        <button class="action-btn btn-green" onclick="openModal('quoteModal')"><span class="material-icons-round">attach_money</span>COTIZAR</button>
        <button class="action-btn btn-amber" onclick="openModal('inventoryModal')"><span class="material-icons-round">inventory_2</span>INV</button>
        <button class="action-btn" onclick="openModal('crmModal')"><span class="material-icons-round">groups</span>CRM</button>
        <button class="action-btn btn-green" onclick="openModal('predictModal')"><span class="material-icons-round">auto_graph</span>PRED</button>
        <button class="action-btn btn-red" onclick="toggleRec()"><span class="material-icons-round">fiber_manual_record</span>REC</button>
        <button class="action-btn" onclick="openModal('topologyModal')"><span class="material-icons-round">hub</span>NET</button>
        <button class="action-btn" onclick="openModal('freezeModal')"><span class="material-icons-round">ac_unit</span>FREEZE</button>
        <button class="action-btn btn-green" onclick="openModal('serviceModal')"><span class="material-icons-round">build</span>SERV</button>
        <button class="action-btn btn-green" onclick="openModal('scopeModal')"><span class="material-icons-round">ssid_chart</span>SCOPE</button>
        <button class="action-btn" onclick="openModal('sensorModal')"><span class="material-icons-round">tune</span>SENSORES</button>
        <button class="action-btn btn-amber" onclick="openOdometerTool()"><span class="material-icons-round">speed</span>KM</button>
        <button class="action-btn" onclick="openModal('garageModal')"><span class="material-icons-round">directions_car</span>GARAJE</button>
        <button class="action-btn btn-green" onclick="openModal('testsModal')"><span class="material-icons-round">bolt</span>TEST</button>
        <button class="action-btn btn-amber" onclick="testSecurity()"><span class="material-icons-round">lock_open</span>SEGURIDAD</button>
        <button class="action-btn btn-red" onclick="openHexEditor()"><span class="material-icons-round">memory</span>HEX</button>
        <button class="action-btn" onclick="openModal('historyModal')"><span class="material-icons-round">history</span>HIST</button>
        <button class="action-btn" onclick="openModal('settingsModal')"><span class="material-icons-round">settings</span>CONF</button>
        <button class="action-btn btn-blue" onclick="connectOrSync()"><span class="material-icons-round">bluetooth</span>SYNC</button>
    </div>

    <button class="scan-btn" onclick="startScan()">üîç ESCANEAR SISTEMA</button>
    <div class="console" id="console"><div>> AutoFix v6.0.0 APK Ready.</div></div>

    <div id="odoModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="closeModal('odoModal')">&times;</span><h2>OD√ìMETRO</h2><div class="odo-display" id="odo-current">---</div><input type="number" id="odo-new" class="input-dark" placeholder="Nuevo Km"><button class="btn-full" onclick="writeOdometer()">PROGRAMAR</button></div></div>
    
    <div id="settingsModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="closeModal('settingsModal')">&times;</span><h2>CONFIGURACI√ìN</h2>
        <label>Interface Hardware</label><select id="conf-hw" class="input-dark"><option value="sim">üîå Modo Simulaci√≥n</option><option value="elm">üì∂ ELM327 BLE (Real)</option><option value="j2534">üì° J2534 Passthru</option><option value="usb">üíª Cable USB</option></select>
        <label>Motor de IA</label><select id="conf-ai" class="input-dark"><option value="gemini">‚ú® Google Gemini Ultra</option><option value="gpt">üß† GPT-4 Turbo</option></select>
        <label>Taller</label><input type="text" class="input-dark" value="Taller Principal"><button class="btn-full" onclick="saveSettings()">GUARDAR</button></div></div>

    <div id="inventoryModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="closeModal('inventoryModal')">&times;</span><h2>INVENTARIO</h2><table class="data-table"><tr><th>Item</th><th>Stock</th></tr><tr><td>Filtro 5W30</td><td>12</td></tr><tr><td>Buj√≠a NGK</td><td>24</td></tr></table></div></div>
    <div id="crmModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="closeModal('crmModal')">&times;</span><h2>CRM</h2><p>Juan P. - Fiesta 2015 (Listo)</p></div></div>
    <div id="quoteModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="closeModal('quoteModal')">&times;</span><h2>COTIZAR</h2><p>Total: $ 85.00</p><button class="btn-full">GENERAR</button></div></div>
    <div id="predictModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="closeModal('predictModal')">&times;</span><h2>IA</h2><p>Salud: 85%</p></div></div>
    <div id="topologyModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="closeModal('topologyModal')">&times;</span><h2>CAN BUS</h2><p>ECU ‚óè OK</p></div></div>
    <div id="scopeModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="closeModal('scopeModal')">&times;</span><h2>SCOPE</h2><canvas id="scopeCanvas" style="width:100%; height:150px; background:#000;"></canvas></div></div>
    <div id="sensorModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="closeModal('sensorModal')">&times;</span><h2>SENSORES</h2><p id="live-rpm">RPM: ---</p></div></div>
    <div id="testsModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="closeModal('testsModal')">&times;</span><h2>TESTS</h2><button class="btn-full">FAN OFF</button></div></div>
    <div id="historyModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="closeModal('historyModal')">&times;</span><h2>HISTORIAL</h2><p>Log 12/12 - OK</p></div></div>
    <div id="hexModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="closeModal('hexModal')">&times;</span><h2>HEX</h2><textarea class="input-dark">00 FF...</textarea></div></div>
    <div id="freezeModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="closeModal('freezeModal')">&times;</span><h2>FREEZE</h2><p>P0300</p></div></div>
    <div id="garageModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="closeModal('garageModal')">&times;</span><h2>GARAJE</h2><p>Sentra 2018</p></div></div>
    <div id="serviceModal" class="modal"><div class="modal-content"><span class="close-modal" onclick="closeModal('serviceModal')">&times;</span><h2>SERVICIO</h2><button class="btn-full">OIL RESET</button></div></div>

    <script>
        const API_URL = "https://autofix-server-7w12.onrender.com";
        let currentUserPlan = 'FREE';
        let simulatedKm = 125430;
        let hardwareMode = 'sim';

        async function attemptLogin() {
            const email = document.getElementById('login-email').value.trim();
            const btn = document.getElementById('btnLogin');
            if(!email) { alert("Escribe correo"); return; }
            btn.innerText = "CONECTANDO..."; btn.disabled = true;
            try {
                const r = await fetch(`${API_URL}/api/login`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ email: email })
                });
                const d = await r.json();
                if (d.status === 'success') {
                    currentUserPlan = d.plan;
                    document.getElementById('loginOverlay').style.display = 'none';
                    setInterval(mainLoop, 1000);
                } else { alert(d.message); btn.disabled = false; }
            } catch (e) { alert("Error Red Render"); btn.disabled = false; }
        }

        function mainLoop() { if (hardwareMode === 'sim') updateFromRender(); else setStatusOffline(); }

        async function updateFromRender() {
            try {
                const r = await fetch(`${API_URL}/live`);
                const d = await r.json();
                document.getElementById('rpm-val').innerText = d.rpm;
                document.getElementById('temp-val').innerText = d.coolant_temp + "¬∞C";
                document.getElementById('rpm-circle').style.strokeDashoffset = 251 - (d.rpm/8000*251);
                document.getElementById('temp-circle').style.strokeDashoffset = 251 - (d.coolant_temp/130*251);
                document.getElementById('conn-dot').className = 'dot active';
                document.getElementById('conn-text').innerText = "SIM: " + d.vin;
            } catch(e) {}
        }

        function setStatusOffline() { 
            // ============================================
            // CORRECCI√ìN CONFIRMADA v6.0.0 - RESETEO TOTAL
            // ============================================
            
            // 1. Reset RPM
            document.getElementById('rpm-val').innerText = "--"; 
            document.getElementById('rpm-circle').style.strokeDashoffset = 251; 
            
            // 2. Reset Temperatura
            document.getElementById('temp-val').innerText = "--"; 
            document.getElementById('temp-circle').style.strokeDashoffset = 251; 

            // 3. Reset Estado
            document.getElementById('conn-dot').className = 'dot'; 
            document.getElementById('conn-text').innerText = "OFFLINE"; 
        }

        async function connectBluetooth() {
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') { alert("Bluetooth requiere HTTPS seguro."); return; }
            if (!navigator.bluetooth) { alert("Bluetooth no disponible en este dispositivo."); return; }
            try {
                const device = await navigator.bluetooth.requestDevice({ filters: [{ services: ['000018f0-0000-1000-8000-00805f9b34fb'] }], optionalServices: ['0000fff0-0000-1000-8000-00805f9b34fb'] });
                alert("Conectado a: " + device.name);
            } catch (e) { alert("Error: " + e.message); }
        }

        function connectOrSync() { if (hardwareMode === 'elm') connectBluetooth(); else window.location.reload(true); }
        function saveSettings() { hardwareMode = document.getElementById('conf-hw').value; alert("Configuraci√≥n Aplicada."); closeModal('settingsModal'); }
        function openOdometerTool() { if(currentUserPlan !== 'MASTER') { alert("Nivel MASTER requerido"); return; } openModal('odoModal'); document.getElementById('odo-current').innerText = simulatedKm.toLocaleString() + " Km"; }
        function writeOdometer() { simulatedKm = parseInt(document.getElementById('odo-new').value); document.getElementById('odo-current').innerText = simulatedKm.toLocaleString() + " Km"; alert("Escritura Completa."); }
        function openModal(id) { document.getElementById(id).style.display = 'block'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function toggleSunMode() { document.body.style.background = document.body.style.background==='white'?'#0a0a0f':'white'; }
        function toggleVoice() { alert("Micr√≥fono Escuchando..."); }
        function startScan() { alert("Escan√©o OBD2 Completo."); }
        function testSecurity() { alert("Acceso de Seguridad: OK"); }
        function toggleRec() { alert("Grabaci√≥n de Datos ON"); }
        function openHexEditor(){openModal('hexModal')}
    </script>
</body>
</html>
